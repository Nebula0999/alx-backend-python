#!/bin/bash
# kubctl-0x01.sh
# Script to scale a Kubernetes deployment, verify pods, load test, and monitor usage.

DEPLOYMENT_NAME=django-messaging-app
NAMESPACE=default
SERVICE_NAME=django-messaging-service
PORT=8000

echo "ğŸ“¦ Scaling $DEPLOYMENT_NAME to 3 replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=3 -n $NAMESPACE

echo "â³ Waiting for pods to be ready..."
kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE

echo "ğŸ” Verifying pods..."
kubectl get pods -n $NAMESPACE -o wide

echo "ğŸ“Œ Port-forwarding service for local access..."
kubectl port-forward svc/$SERVICE_NAME $PORT:$PORT -n $NAMESPACE &
PORT_FORWARD_PID=$!

# Give it a few seconds to establish
sleep 5

echo "ğŸš€ Running load test with wrk..."
wrk -t4 -c100 -d30s http://localhost:$PORT/

echo "ğŸ“Š Monitoring resource usage..."
kubectl top pods -n $NAMESPACE

echo "ğŸ›‘ Stopping port-forward..."
kill $PORT_FORWARD_PID
echo "âœ… Deployment and testing completed successfully."